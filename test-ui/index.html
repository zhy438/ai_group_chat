<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI群聊 - 调试面板</title>
    <link rel="stylesheet" href="style.css?v=20240120">
    <!-- 引入 Markdown 渲染库 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- 引入代码高亮库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>

<body>
    <div class="container">
        <!-- 侧边栏：群聊列表 -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>🤖 AI群聊</h2>
                <button id="createGroupBtn" class="btn btn-primary">+ 新建群聊</button>
            </div>
            <div id="groupList" class="group-list">
                <p class="empty-hint">暂无群聊，点击上方按钮创建</p>
            </div>
        </aside>

        <!-- 主区域 -->
        <main class="main-content">
            <!-- 群聊信息栏 -->
            <header class="chat-header" id="chatHeader" style="display: none;">
                <div class="header-left">
                    <div class="chat-title">
                        <h3 id="currentGroupName">选择一个群聊</h3>
                        <span id="memberCount" class="member-count"></span>
                    </div>

                    <!-- 紧凑型上下文状态 -->
                    <div id="minContextStats" class="mini-context-stats" style="display: none;">
                        <div class="stats-row">
                            <span class="stat-item" title="当前/最大 Token">
                                📊 <span id="currentTokens">0</span> / <span id="maxTokens">0</span>
                            </span>
                            <span class="stat-item highlight" id="contextProgressText">0%</span>
                            <button id="refreshContextBtn" class="icon-btn" title="刷新状态">🔄</button>
                        </div>
                        <div class="mini-progress-track" title="压缩阈值: 80%">
                            <div class="mini-progress-bar" id="contextProgressBar"></div>
                            <div class="mini-threshold-mark" id="thresholdMarker" title="压缩阈值"></div>
                        </div>
                        <!-- New: Compression Threshold Slider -->
                        <div class="threshold-control"
                            style="font-size: 10px; margin-top: 4px; display: flex; align-items: center; gap: 4px; opacity: 0.8;">
                            <label for="thresholdSlider" title="动态调整压缩阈值">⚙️ 阈值:</label>
                            <input type="range" id="thresholdSlider" min="0.1" max="1.0" step="0.05" value="0.8"
                                style="width: 60px; height: 4px;">
                            <span id="thresholdValue" title="当前设定值">80%</span>
                        </div>
                    </div>
                </div>

                <div class="header-actions">
                    <button id="setManagerBtn" class="btn btn-secondary">管理员设置</button>
                    <button id="addMemberBtn" class="btn btn-secondary">+ 添加成员</button>
                    <button id="deleteGroupBtn" class="btn btn-danger">删除群聊</button>
                </div>
            </header>

            <!-- 成员列表 -->
            <div id="memberSection" class="member-section" style="display: none;">
                <h4>群聊成员</h4>
                <div id="memberList" class="member-list"></div>
            </div>

            <!-- 消息区域 -->
            <div id="messageArea" class="message-area">
                <div class="welcome-screen">
                    <div class="welcome-icon">💬</div>
                    <h3>欢迎使用 AI群聊调试面板</h3>
                    <p>选择或创建一个群聊开始测试</p>
                </div>
            </div>

            <!-- 讨论输入区 -->
            <div id="discussionPanel" class="discussion-panel" style="display: none;">
                <div class="discussion-config">
                    <label>
                        你的昵称：
                        <input type="text" id="userName" value="用户" placeholder="输入你的昵称">
                    </label>
                    <label>
                        讨论轮数：
                        <input type="number" id="maxRounds" value="2" min="1" max="10">
                    </label>
                    <label>
                        讨论模式：
                        <select id="discussionModeSelect">
                            <option value="free" selected>自由讨论 (Auto Team)</option>
                            <option value="qa">一问一答 (QA Grid)</option>
                        </select>
                    </label>
                </div>
                <div class="input-area">
                    <textarea id="questionInput" placeholder="输入你的问题或话题，让AI们讨论..."></textarea>
                    <div class="input-action-column"
                        style="display: flex; flex-direction: column; gap: 8px; width: 120px;">
                        <button id="startDiscussionBtn" class="btn btn-primary" style="flex: 1; margin: 0; padding: 0;">
                            🚀 开始讨论
                        </button>
                        <button id="stopDiscussionBtn" class="btn"
                            style="flex: 1; margin: 0; padding: 0; background-color: #ef4444; color: white; border: none; display: none;">
                            🛑 终止讨论
                        </button>
                        <button id="summarizeBtn" class="btn btn-secondary"
                            style="flex: 1; margin: 0; padding: 0; background-color: #5a6b7c; color: white; border: none;">
                            📝 得出结论
                        </button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- 模态框：创建群聊 -->
    <div id="createGroupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>创建新群聊</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <label>
                    群聊名称：
                    <input type="text" id="newGroupName" placeholder="例如：技术讨论组">
                </label>
                <label>
                    讨论模式：
                    <select id="newGroupMode">
                        <option value="free">自由讨论 (Free Chat)</option>
                        <option value="qa">一问一答 (QA Parallel)</option>
                    </select>
                </label>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary cancel-btn">取消</button>
                <button id="confirmCreateGroup" class="btn btn-primary">创建</button>
            </div>
        </div>
    </div>

    <!-- 模态框：添加成员 -->
    <div id="addMemberModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>添加AI成员</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <label>
                    AI模型：
                    <select id="memberModel">
                        <!-- 动态加载 -->
                    </select>
                </label>
                <label>
                    人设描述（可选）：
                    <textarea id="memberDescription" placeholder="例如：你是一个严谨的技术专家..."></textarea>
                </label>
                <label>
                    温度：
                    <input type="range" id="memberTemperature" min="0" max="2" step="0.1" value="0.7">
                    <span id="temperatureValue">0.7</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="memberThinking">
                    开启深度思考 (Thinking)
                </label>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary cancel-btn">取消</button>
                <button id="confirmAddMember" class="btn btn-primary">添加</button>
            </div>
        </div>
    </div>

    <!-- 模态框：设置管理员 -->
    <div id="setManagerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>管理员设置</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <p>管理员负责决定谁下一个发言。</p>
                <label>
                    选择模型：
                    <select id="managerModel">
                        <option value="gpt-4o">gpt-4o</option>
                        <option value="gpt-4o-mini" selected>gpt-4o-mini</option>
                        <option value="deepseek-chat">deepseek-chat</option>
                        <option value="qwen-flash">qwen-flash</option>
                        <option value="mimo-v2-flash-free">mimo-v2-flash-free</option>
                    </select>
                </label>
                <label>
                    温度：
                    <input type="range" id="managerTemperature" min="0" max="2" step="0.1" value="0.7">
                    <span id="managerTemperatureValue">0.7</span>
                </label>
                <div class="control-row" style="margin-top: 15px;">
                    <span>🧠 开启 Thinking</span>
                    <label class="switch">
                        <input type="checkbox" id="managerThinking">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary cancel-btn">取消</button>
                <button id="confirmSetManager" class="btn btn-primary">确定</button>
            </div>
        </div>
    </div>

    <!-- 模态框：编辑成员 -->
    <div id="editMemberModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>编辑成员参数</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <label>
                    人设描述：
                    <textarea id="editMemberDescription" placeholder="例如：你是一个严谨的技术专家..."></textarea>
                </label>
                <label>
                    温度：
                    <input type="range" id="editMemberTemperature" min="0" max="2" step="0.1" value="0.7">
                    <span id="editTemperatureValue">0.7</span>
                </label>
                <label class="checkbox-label">
                    <input type="checkbox" id="editMemberThinking">
                    开启深度思考 (Thinking)
                </label>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary cancel-btn">取消</button>
                <button id="confirmEditMember" class="btn btn-primary">保存</button>
            </div>
        </div>
    </div>

    <script src="app.js?v=20240120-7"></script>
</body>

</html>